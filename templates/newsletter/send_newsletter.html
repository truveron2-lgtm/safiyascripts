{% extends 'base_admin.html' %}
{% block content %}
{% include 'newsletter/style.html' %}

<div class="container mt-4">
    <div class="card p-4 mx-auto text-center" style="max-width: 700px;">
        <h2 class="mb-4">Sending Newsletter...</h2>

        <div class="progress" style="height: 30px; border-radius: 8px;">
            <div 
                class="progress-bar bg-success" 
                id="bar" 
                role="progressbar" 
                style="width: 0%; font-weight: bold;"
                aria-valuenow="0" 
                aria-valuemin="0" 
                aria-valuemax="100">
                0%
            </div>
        </div>

        <p class="mt-3">Sending to {{ total }} subscribers. Please wait...</p>
    </div>
</div>

<script>
(function(){
    const newsletterId = {{ newsletter.id }};
    const startUrl = "{% url 'newsletter:start_send_background' newsletter.id %}";
    const progressUrl = "{% url 'newsletter:sending_progress' newsletter.id %}";
    const sentUrl = "{% url 'newsletter:sent_confirmation' newsletter.id %}";

    // CSRF token for POST
    function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
    }
    const csrftoken = getCookie('csrftoken');

    // start background send
    fetch(startUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({start: true})
    }).then(r => r.json()).then(res => {
        // polling
        function poll(){
            fetch(progressUrl)
            .then(r => r.json())
            .then(data => {
                const bar = document.getElementById('bar');
                bar.style.width = data.progress + '%';
                bar.innerText = data.progress + '%';

                if (data.progress < 100 || data.running) {
                    setTimeout(poll, 600);
                } else {
                    // finished
                    window.location.href = sentUrl;
                }
            })
            .catch(err => {
                console.error('progress error', err);
                setTimeout(poll, 1500);
            });
        }
        poll();
    }).catch(err => {
        console.error('start send error', err);
        alert('Could not start sending. Please try again.');
    });
})();
</script>

{% endblock %}
