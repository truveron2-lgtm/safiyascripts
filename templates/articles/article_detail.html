{% extends "base_admin.html" %}
{% block content %}
<div class="container mt-4">

  <!-- ✅ Display Django messages -->
  {% if messages %}
    <div class="mt-3">
      {% for message in messages %}
        <div 
          class="alert 
          {% if message.tags == 'error' %}alert-danger text-danger
          {% elif message.tags == 'success' %}alert-success
          {% elif message.tags == 'warning' %}alert-warning
          {% else %}alert-info{% endif %}
          alert-dismissible fade show shadow-sm" 
          role="alert">
          {{ message|safe }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ✅ Article header -->
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h2 class="fw-bold">{{ article.title }}</h2>
      <p class="text-muted">
        By {{ article.author.username }} | {{ article.date_posted|date:"M d, Y" }}
      </p>
    </div>

    <!-- ✅ Admin or Author Actions -->
    {% if request.user.is_authenticated %}
      {% if request.user.is_staff or request.user == article.author %}
        <div class="btn-group">
          <a href="{% url 'articles:article_edit' pk=article.pk %}" class="btn btn-sm btn-outline-warning">
            <i class="bi bi-pencil-square"></i> Edit
          </a>
          <form method="post" action="{% url 'articles:article_delete' pk=article.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger" 
                    onclick="return confirm('Are you sure you want to delete this article?');">
              <i class="bi bi-trash"></i> Delete
            </button>
          </form>
        </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- ✅ Article image -->
  {% if article.image %}
    <img src="{{ article.image.url }}" 
         class="img-fluid rounded my-4 shadow-sm" 
         alt="{{ article.title }}">
  {% endif %}

  <!-- ✅ Article content -->
  <div class="article-body mb-5">
    <p class="fs-5">{{ article.full_description|linebreaks }}</p>
  </div>

  <!-- ✅ Back button -->
  {% if request.user.is_staff %}
    <a href="{% url 'articles:article_list' %}" class="btn btn-secondary mb-5">
      ← Back to Articles
    </a>
  {% else %}
    <a href="{% url 'articles:article_list_public' %}" class="btn btn-secondary mb-5">
      ← Back to Articles
    </a>
  {% endif %}

  <hr class="my-4">

  <!-- ✅ Comments section -->
  <h4 class="mb-4 fw-semibold">Comments</h4>
  <div class="mt-3">
    {% if comments %}
      {% for comment in comments %}
        {% include "articles/comment_thread.html" with comment=comment %}
      {% endfor %}
    {% else %}
      <p class="text-muted">No comments yet.</p>
    {% endif %}
  </div>
</div>

<!-- ✅ JS: Alerts auto-close & inline replies -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Auto-dismiss alerts
  document.querySelectorAll('.alert').forEach(alert => {
    if (typeof bootstrap !== 'undefined') {
      setTimeout(() => {
        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
        bsAlert.close();
      }, 4000);
    }
  });

  // Inline reply functionality
  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("reply-link")) {
      e.preventDefault();
      const commentId = e.target.getAttribute("data-comment");

      // Remove any existing form first
      const existingForm = document.querySelector(".active-reply-form");
      if (existingForm) existingForm.remove();

      // Add reply form dynamically
      const formHtml = `
        <form method="post" action="{% url 'articles:admin_reply_comment' pk=article.pk %}"
              class="active-reply-form mt-3 p-3 border rounded bg-light shadow-sm">
          {% csrf_token %}
          <div class="mb-2">
            <textarea name="content" class="form-control" rows="3"
                      placeholder="Write your reply..." required></textarea>
          </div>
          <input type="hidden" name="parent_id" value="${commentId}">
          <button type="submit" class="btn btn-sm btn-primary">Post Reply</button>
          <button type="button" class="btn btn-sm btn-secondary cancel-reply">Cancel</button>
        </form>
      `;
      e.target.insertAdjacentHTML("afterend", formHtml);
    }

    if (e.target.classList.contains("cancel-reply")) {
      e.preventDefault();
      e.target.closest("form").remove();
    }
  });
});
</script>

{% endblock %}
