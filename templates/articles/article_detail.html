{% extends "base_admin.html" %}
{% block content %}
<div class="container mt-4">

  <!-- ✅ Display messages -->
  {% if messages %}
    <div class="mt-3">
      {% for message in messages %}
        <div 
          class="alert 
          {% if message.tags == 'error' %}alert-danger text-danger{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %}
          alert-dismissible fade show shadow-sm" 
          role="alert">
          {{ message|safe }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ✅ Article section -->
  <h2 class="fw-bold">{{ article.title }}</h2>
  <p class="text-muted">By {{ article.author.username }} | {{ article.date_posted|date:"M d, Y" }}</p>
  
  {% if article.image %}
    <img src="{{ article.image.url }}" class="img-fluid rounded mb-4 shadow-sm" alt="{{ article.title }}">
  {% endif %}

  <hr>
  <p class="fs-5">{{ article.full_description|linebreaks }}</p>

  {% if user == article.author %}
    <a href="{% url 'articles:article_edit' article.pk %}" class="btn btn-warning me-2">Edit</a>
    <a href="{% url 'articles:article_delete' article.pk %}" class="btn btn-danger">Delete</a>
  {% endif %}

  <a href="{% url 'articles:article_list' %}" class="btn btn-secondary mt-3">← Back to Articles</a>

  <hr class="my-5">

  <!-- ✅ Comments section -->
  <h4 class="mb-4">Comments</h4>
  <div class="mt-3">
    {% if comments %}
      {% for comment in comments %}
        {% include "articles/comment_thread.html" with comment=comment %}
      {% endfor %}
    {% else %}
      <p class="text-muted">No comments yet.</p>
    {% endif %}
  </div>

</div>

<!-- ✅ Inline reply functionality (for admin replies only) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Auto-dismiss alerts
  document.querySelectorAll('.alert').forEach(alert => {
    if (typeof bootstrap !== 'undefined') {
      setTimeout(() => {
        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
        bsAlert.close();
      }, 4000);
    }
  });

  // ✅ Handle reply clicks
  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("reply-link")) {
      e.preventDefault();
      const commentId = e.target.getAttribute("data-comment");

      // Remove any existing reply form first
      const existingForm = document.querySelector(".active-reply-form");
      if (existingForm) existingForm.remove();

      // Create new inline reply form
      const formHtml = `
        <form method="post" action="{% url 'articles:admin_reply_comment' article.id %}"

              class="active-reply-form mt-3 p-3 border rounded bg-light shadow-sm">
          {% csrf_token %}
          <div class="mb-2">
            <textarea name="content" class="form-control" rows="3" 
                      placeholder="Write your reply..." required></textarea>
          </div>
          <input type="hidden" name="parent_id" value="${commentId}">
          <button type="submit" class="btn btn-sm btn-primary">Post Reply</button>
          <button type="button" class="btn btn-sm btn-secondary cancel-reply">Cancel</button>
        </form>
      `;

      // Insert the form right after the reply link
      e.target.insertAdjacentHTML("afterend", formHtml);
    }

    // ✅ Cancel reply
    if (e.target.classList.contains("cancel-reply")) {
      e.preventDefault();
      e.target.closest("form").remove();
    }
  });
});
</script>

{% endblock %}
